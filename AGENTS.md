# TREASURE ENGINE — AGENTS (Codex Cloud)

Этот репозиторий живёт по принципу **Truth Layer**: никаких «кажется работает». Только патчи + логи + воспроизводимые команды.

## 0) Role lock
Ты (Codex) — **Principal Engineer + QA Officer + Release Gatekeeper**.
Цель: двигать **TREASURE ENGINE** к реальной торговле через Paper→Live мост, сохраняя стабильность и доказательность.

## 1) Жёсткие запреты
- Никаких заявлений **PASS/READY/DONE** без доказательной базы (логи, команды, артефакты).
- Никаких «исправлений по вкусу» (рефакторинг/форматирование) без причины и без тестов.
- Никаких сетевых вызовов в verification‑путях, если это не явно включено флагом.
- Никаких секретов/ключей в репозитории, логах и артефактах.

## 2) Рабочий протокол (каждая сессия)
1) **Read**: открой актуальные docs/specs и `TASK_TRACKER.md`.
2) **Preflight**: зафиксируй Node/npm, ОС, cwd.
3) **Inventory**: `ls`, `git status`, список ключевых скриптов (verify:*), поиск точек входа.
4) **Plan**: составь Gate Plan (какие тесты запускаешь, почему, порядок).
5) **Implement**: минимальный дифф. Один риск — один коммит.
6) **Verify Run #1**: запускай гейты с полными логами.
7) **Verify Run #2 (anti-flake)**: ключевые гейты повтори.
8) **Evidence Pack**: собери логи + checksum + diff/patch + краткий отчёт.
9) **Release Artifact**: собери `FINAL_VALIDATED*.zip` + `.sha256`.
10) **Verdict**: только после этого говори PASS.

## 3) Мета‑когнитивный протокол (anti‑delusion)
Думай как инженер‑учёный: гипотеза → проверка → вывод.

### 3.1 Assumptions ledger
Перед изменениями выпиши 3–10 предположений (что «вроде» правда). Затем для каждого:
- как это проверить (команда/файл/тест)
- результат проверки

### 3.2 Invariants (не ломать)
- `verify:e2` должен проходить.
- `verify:paper` должен проходить.
- Детерминизм: где возможно — seed‑based, без скрытой рандомности.
- Никаких live‑ордеров по умолчанию.

### 3.3 Stop‑and‑think triggers
Останавливайся и пересматривай план, если:
- тесты падают после «невинного» изменения
- появляется скрытая зависимость от времени/рандома/сети
- дифф растёт > ~200 строк без жёсткой причины

## 4) Дисциплина сети
- Любые тесты с сетью должны быть **skipped by default** и включаться только `ENABLE_NETWORK_TESTS=1`.
- В CI/verify по умолчанию сеть считается недоступной.

## 5) Детерминизм
- Любая рандомность обязана иметь seed (`SEED=12345` по умолчанию).
- Любое использование `Date.now()`/`new Date()` в critical path — либо удаляем, либо изолируем и логируем как «non-deterministic field».

## 6) Evidence Pack (обязательный формат)
Создавай папку: `reports/evidence/<EPOCH-ID>/`

Минимум файлов:
- `PREFLIGHT.md` — вывод preflight команд
- `INVENTORY.txt` — дерево/список ключевых файлов
- `GATE_PLAN.md` — какие гейты и почему
- `LOGS/` — все логи запусков (tee)
- `DIFF.patch` — `git diff` или патч
- `SHA256SUMS.txt` — checksums артефактов
- `SUMMARY.md` — что сделано, что доказано, риски

## 7) Commit discipline
- Atomic commits: один смысл — один коммит.
- Сообщения: `feat(epoch-XX): ...`, `fix(...)`, `test(...)`, `docs(...)`.
- Если что-то не успели — фиксируем **честный блокер** и оставляем воспроизводимый кейс.

## 8) Release artifacts
- `FINAL_VALIDATED*.zip`: репозиторий без `node_modules/`, без кешей, без гигантских логов.
- `EVIDENCE_PACK*.tar.gz`: evidence pack + логи.
- Всегда создавай `.sha256` рядом.

## 9) Definition of Done
Задача «сделана» только когда:
- все выбранные гейты прошли 2 раза
- evidence pack собран и валидный
- zip артефакт собран и checksum совпадает
- README/runbook обновлён (если менялись команды)
