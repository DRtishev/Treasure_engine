#!/usr/bin/env node
import { spawnSync } from 'node:child_process'; import { enforceCIBoundaryE129, isCITruthy, snapshotState, writeMdAtomic } from './e129_lib.mjs';
enforceCIBoundaryE129(); const update=process.env.UPDATE_E129_EVIDENCE==='1'; if(update&&isCITruthy()) throw new Error('E129_CI_UPDATE_REJECTED'); const pp=['.foundation-seal/E129_INPUT_BINDING.json','.foundation-seal/runs','.foundation-seal/capsules','.foundation-seal/overlay','.foundation-seal/ledger']; const b=snapshotState(pp); const gb=spawnSync('git',['status','--porcelain'],{encoding:'utf8'}).stdout; const r=spawnSync('node',['scripts/verify/e129_evidence.mjs'],{stdio:'inherit',env:{...process.env}}); if((r.status??1)!==0){const a=snapshotState(pp); writeMdAtomic('reports/evidence/E129/ZERO_WRITES_ON_FAIL.md',['# E129 ZERO WRITES ON FAIL',`- status: ${b===a?'PASS':'FAIL'}`,'- reason: orchestrator_fail_path',`- state_before: ${b}`,`- state_after: ${a}`].join('\n')); process.exit(r.status??1);} const ga=spawnSync('git',['status','--porcelain'],{encoding:'utf8'}).stdout; if(!update&&gb!==ga) throw new Error('E129_READ_ONLY_VIOLATION');
