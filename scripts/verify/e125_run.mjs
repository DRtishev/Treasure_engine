#!/usr/bin/env node
import { spawnSync } from 'node:child_process'; import { enforceCIBoundaryE125, isCITruthy, snapshotState, writeMdAtomic } from './e125_lib.mjs';
enforceCIBoundaryE125(); const update=process.env.UPDATE_E125_EVIDENCE==='1'; if(update&&isCITruthy()) throw new Error('E125_CI_UPDATE_REJECTED'); const pp=['.foundation-seal/E125_INPUT_BINDING.json','.foundation-seal/runs','.foundation-seal/capsules','.foundation-seal/overlay','.foundation-seal/ledger']; const b=snapshotState(pp); const bg=spawnSync('git',['status','--porcelain'],{encoding:'utf8'}).stdout; const r=spawnSync('node',['scripts/verify/e125_evidence.mjs'],{stdio:'inherit',env:{...process.env}}); if((r.status??1)!==0){const a=snapshotState(pp); const ok=b===a; writeMdAtomic('reports/evidence/E125/ZERO_WRITES_ON_FAIL.md',['# E125 ZERO WRITES ON FAIL',`- status: ${ok?'PASS':'FAIL'}`,'- reason: orchestrator_fail_path',`- state_before: ${b}`,`- state_after: ${a}`,'- fallback_ratio: 1.0000','- freshness_ok: false'].join('\n')); process.exit(r.status??1);} const ag=spawnSync('git',['status','--porcelain'],{encoding:'utf8'}).stdout; if(!update&&bg!==ag) throw new Error('E125_READ_ONLY_VIOLATION');
